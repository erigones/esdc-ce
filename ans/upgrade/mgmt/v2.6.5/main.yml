#
# https://github.com/erigones/esdc-ce/wiki/Known-Issues#network-down-in-vms-after-update-of-cloud-init-or-centos
#
- name: Fix parsing of network interfaces
  lineinfile: dest="/etc/rc.d/rc.local"
              regexp="^interfaces=\"\$\(ifconfig -a | grep \^eth | awk -F':' \'{print \$1}\'\)\""
              line="interfaces=\"$(ifconfig -a | grep -E \'^eth|^net\' | awk -F':' \'{print $1}\')\""

- name: Make /etc/rc.d/rc.local executable
  file: path=/etc/rc.d/rc.local
        owner=root
        group=root
        mode=0755

- name: Fix firewall rules (eth0 -> net0)
  lineinfile:
    dest=/etc/sysconfig/iptables
    state=present
    insertafter='^-A INPUT -m state --state NEW'
    line='{{ item }}'
  with_items:
    - '-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -i net0 -j ACCEPT'
    - '-A INPUT -m state --state NEW -m tcp -p tcp --dport 5672 -i net0 -j ACCEPT'
    - '-A INPUT -m state --state NEW -m tcp -p tcp --dport 6379 -i net0 -j ACCEPT'
    - '-A INPUT -m state --state NEW -m tcp -p tcp --dport 6432 -i net0 -j ACCEPT'
    - '-A INPUT -m state --state NEW -m tcp -p tcp --dport 10050 -i net0 -j ACCEPT'

# https://github.com/erigones/esdc-factory/pull/73
# https://github.com/erigones/esdc-factory/pull/79
- name: Add items for monitoring HA of the mgmt DB
  lineinfile:
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    line='{{ item }}'
    insertafter='^UserParameter'
  with_items:
    - 'UserParameter=pgsql.ha.connected_slaves[*],/usr/bin/psql -h 127.0.0.1 -p 5432 -U stats -d postgres -At -c "SELECT count(*) FROM pg_stat_replication"'
    - "UserParameter=pgsql.ha.is_slave[*],/usr/bin/psql -h 127.0.0.1 -p 5432 -U stats -d postgres -At -c \"SELECT CASE WHEN pg_is_in_recovery() = 't' THEN 1 ELSE 0 END AS in_recovery;\""
    - 'UserParameter=pgsql.ha.master_exists[*],/usr/sbin/crm_resource --resource postgres-ha | grep -Ec "Masters: \[ [^ ]+ \]"'
  notify: restart zabbix-agent

